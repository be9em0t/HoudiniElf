
	-- buildings with parts (H3 multi-resolution filter)
	-- Filters by H3 tiles at multiple resolutions to avoid missing geometries
WITH h3_tiles AS (
	SELECT * FROM (VALUES
        ('8019fffffffffff', 0),
        ('831968fffffffff', 3),
        ('831969fffffffff', 3),
        ('8419683ffffffff', 4),
        ('8419695ffffffff', 4),
        ('841969dffffffff', 4),
        ('85196827fffffff', 5),
        ('85196953fffffff', 5),
        ('851969cbfffffff', 5),
        ('86196826fffffff', 6),
        ('861969527ffffff', 6),
        ('861969537ffffff', 6),
        ('861969c8fffffff', 6),
        ('861969c9fffffff', 6),
        ('871968269ffffff', 7),
        ('871969520ffffff', 7),
        ('871969522ffffff', 7),
        ('871969524ffffff', 7),
        ('871969525ffffff', 7),
        ('871969526ffffff', 7),
        ('871969530ffffff', 7),
        ('871969534ffffff', 7),
        ('871969535ffffff', 7),
        ('871969c8affffff', 7),
        ('871969c98ffffff', 7),
        ('871969c99ffffff', 7),
        ('871969c9affffff', 7),
        ('871969c9bffffff', 7),
        ('871969c9dffffff', 7),
        ('881968269bfffff', 8),
        ('8819695201fffff', 8),
        ('8819695205fffff', 8),
        ('8819695209fffff', 8),
        ('881969520bfffff', 8),
        ('881969520dfffff', 8),
        ('8819695229fffff', 8),
        ('881969522dfffff', 8),
        ('8819695241fffff', 8),
        ('8819695243fffff', 8),
        ('8819695245fffff', 8),
        ('8819695247fffff', 8),
        ('8819695249fffff', 8),
        ('881969524dfffff', 8),
        ('8819695255fffff', 8),
        ('8819695261fffff', 8),
        ('8819695263fffff', 8),
        ('8819695265fffff', 8),
        ('8819695267fffff', 8),
        ('8819695269fffff', 8),
        ('881969526bfffff', 8),
        ('881969526dfffff', 8),
        ('8819695309fffff', 8),
        ('881969530bfffff', 8),
        ('8819695341fffff', 8),
        ('8819695343fffff', 8),
        ('8819695347fffff', 8),
        ('8819695349fffff', 8),
        ('881969534bfffff', 8),
        ('881969534dfffff', 8),
        ('8819695351fffff', 8),
        ('8819695353fffff', 8),
        ('8819695355fffff', 8),
        ('8819695357fffff', 8),
        ('8819695359fffff', 8),
        ('881969535bfffff', 8),
        ('881969535dfffff', 8),
        ('881969c8a5fffff', 8),
        ('881969c8a7fffff', 8),
        ('881969c981fffff', 8),
        ('881969c983fffff', 8),
        ('881969c985fffff', 8),
        ('881969c987fffff', 8),
        ('881969c98bfffff', 8),
        ('881969c991fffff', 8),
        ('881969c993fffff', 8),
        ('881969c995fffff', 8),
        ('881969c997fffff', 8),
        ('881969c999fffff', 8),
        ('881969c99bfffff', 8),
        ('881969c99dfffff', 8),
        ('881969c9a1fffff', 8),
        ('881969c9a3fffff', 8),
        ('881969c9a5fffff', 8),
        ('881969c9a7fffff', 8),
        ('881969c9a9fffff', 8),
        ('881969c9abfffff', 8),
        ('881969c9adfffff', 8),
        ('881969c9b1fffff', 8),
        ('881969c9b3fffff', 8),
        ('881969c9b5fffff', 8),
        ('881969c9b7fffff', 8),
        ('881969c9b9fffff', 8),
        ('881969c9bbfffff', 8),
        ('881969c9bdfffff', 8),
        ('881969c9d3fffff', 8),
        ('881969c9d7fffff', 8)
	) AS t(h3, h3_resolution)
),

polygons_h3_filtered AS (
	SELECT
		p.orbis_id,
		p.building,
		p.tags,
		p.geometry
	FROM pu_orbis_platform_prod_catalog.map_central_repository.polygons p
	INNER JOIN h3_tiles h ON p.h3_index = h.h3 AND p.h3_resolution = h.h3_resolution
	WHERE (p.building = 'yes' OR p.tags['building'] IS NOT NULL OR p.tags['building:part'] IS NOT NULL)
	  AND p.product = 'nexventura_26060.000'
	  AND p.license_zone LIKE '%NLD%'
	  AND p.h3_index != '0'
)

SELECT 
	p.orbis_id,
	p.tags['layer'] as layer,
	p.tags['type'] as type,
	p.tags['building'] as building,
	p.tags['building:part'] as part,
	p.tags['height'] as height,
	p.tags['min_height'] as min_height,
	p.tags['building:levels'] as levels,
	p.tags['building:min_level'] as min_level,
	p.tags['location'] as location,
	p.tags['construction'] as construction,
	p.tags['zoomlevel_min'] as zoomlevel_min,
	p.geometry
FROM polygons_h3_filtered p
	